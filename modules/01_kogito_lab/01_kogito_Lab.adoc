:noaudio:
:scrollbar:
:data-uri:
:toc2:
:linkattrs:

= RHTE 2019: Cloud-Native and Serverless Processes and Decisions with jBPM, Drools and Quarkus

:numbered:

== Lab environment and setup

.Prerequisites
.. The `ssh` utility installed on your laptop.
.. Web browser installed on your laptop.
.. Broadband internet connectivity.

A lab environment is provided to you. The environment consists of:

* A dedicated Openshift 3.11 cluster.
* A virtual machine with developer tools (git, JDK, Maven, GraalVM) installed.

To obtain access to your lab environment:

. In a browser window, navigate to the RHTE _GuidGrabber_ at https://www.opentlc.com/gg/gg.cgi?profile=???
+
image::images/guid_grabber_1.png[]
. Select the *Lab Code* : `R2016 - Cloud-Native and Serverless Processes and Decisions with jBPM, Drools and Quarkus`
. Enter the *Activation Key* provided by your instructor.
. Enter your *E-Mail Address*.
. Click *Submit*
. The resulting page will display your lab's _GUID_ and other useful information about your lab environment.
+
image::images/guid_grabber_2.png[]
. Open a terminal window and log into the lab virtual machine:
+
----
$ export GUID=<your GUID obtained from the GuidGrabber>
$ ssh lab-user@workstation-$GUID.rhpds.opentlc.com
----
* When prompted, enter the password provided by the instructor.
. From the workstation, you can log into the OpenShift cluster using the `oc` utility:
+
----
$ oc login -u user1 https://master00.example.com -u user1
----
+
.Sample output
----
The server is using a certificate that does not match its hostname: x509: certificate is valid for kubernetes, kubernetes.default, kubernetes.default.sv
c, kubernetes.default.svc.cluster.local, master00.example.com, openshift, openshift.default, openshift.default.svc, openshift.default.svc.cluster.local,
 172.30.0.1, 192.168.0.10, not master00-b8ad.generic.opentlc.com
You can bypass the certificate check, but any data you send to the server could be intercepted by others.
Use insecure connections? (y/n): y

Username: user1
Password:
Login successful.
----
* Accept to use insecure connections.
* When prompted, enter the pasword provided by the instructor.
. To access the OpenShift cluster console from your laptop, open a browser window and navigate to the url https://master00-<GUID>.generic.opentlc.com - replace <GUID> with the lab GUID from the GuidGrabber tool.
* Your OpenShift cluster uses self-signed certificates, so expect a security warning in the browser. Create a security exception and proceed.
* Login with user `user1` and the password provided by the lab instructor.

. Check the namespaces in your OpenShift cluster:
+
----
$ oc get projects
----
+
.Output
----
kafka-cluster                  Active
monitoring                     Active
----
+
* The `kafka-cluster` namespace contains a Strimzi/Kafka deployment.
* The `monitoring` namespace contains a monitoring stack consisting of Prometheus and Grafana.

WARNING: Please perform all lab activities - except those involving a browser - on the workstation virtual machine. +
While it is possible to perform the lab on your laptop - provided you have all the required tools installed - we ask you not to do so, in order to preserve network bandwith, especially when doing Maven builds or uploading/downloading Docker images.

== Use Case

During this workshop we will create and deploy a software system for a startup travel agency called Kogito Travel Agency.
The system will consist of a Kogito _Booking System Service_ implemented with a BPMN2 process definition and rules.

image:images/travels-process.png[]

The _Hotel Booking_ and _Flight Booking_ functionalities are implemented as _private_ subprocesses

image:images/book-hotel-process.png[]

image:images/book-flight-process.png[]

These processes call _Hotel Booking Service_ and _Flight Booking Service_, which are both implemented as CDI beans that have hard coded logic to return a booked flight or hotel.

----
org.acme.travels.service.HotelBookingService
org.acme.travels.service.FlightBookingService
----

Obviously this has been done for simplicity reasons. In a real application these functionalities would be implemented as microservices. However, the current implementation does show the power of Kogito processes definition integration with CDI.

== Cloning the repository
You are provided with a GitHub repository that contains 4 Kogito projects:

* 01-kogito-travel-agency: The base project which contains the _Booking System Service_. This project deploys as a single Quarkus application (JAR or Native Image) and does not support persistence.
* 02-kogito-travel-agency: The base project with persistence support. This project requires Infinispan / JBoss Data Grid.
* 03-kogito-travel-agency: Extension of project 3 with Kafka integration support to implement an Event Driven _Booking System Service_.
* 03-kogito-visas: A second kogito project which contains the _Visa Applications_ service. The _Booking System Service_ interacts with the this service through Kafka.

The GitHub repository can be found here: https://github.com/rhte2019-kogito/kogito-travel-agency-tutorial/


. Login to your workstation as explained in the previous paragraph.
. When logged in, clone the Kogito Lab repository:
+
----
$ git clone https://github.com/rhte2019-kogito/kogito-travel-agency-tutorial.git
----
+
. Navigate tot the _Kogito Travel Agency Tutorial_ folder.
+
----
$ cd kogito-travel-agency-tutorial
----
+
. This folder contains the 3 projects that we will use during this lab.


== Lab 1: Kogito Development

https://kogito.kie.org/[_Kogito_] is the _Cloud-Native Business Automation platform for building Intelligent Applications_.
It's build on top of https://www.quarkus.io[Quarkus], a _Kubernetes Native Java stack tailored for GraalVM & OpenJDK HotSpot, crafted from the best of breed Java libraries and standards_.

One of the focusses of Quarkus, and thus of Kogito, is _Developer Experience_. Functionalities like _dev mode_ and _hot reload_ allows developers to make changes in their source code and configuration files, and immediately have these changes available in their test environment, without the need to explicitly compile and redeploy the application. This _hot reload_ functionality is only activated when the application is refreshed (for example when hitting the application with a RESTful request).

When you run `mvn compile quarkus:dev` {project-name}, the Kogito/Quarkus application will launch in development mode. When
it receives a HTTP request it will hold the request, and check to see if any application source
files (Java code, process definitions, rule definitions, etc.) have been changed. If they have it will transparently compile the changed files, redeploy
the application with the changed files, and then the HTTP request will continue to the redeployed
application. Project redeploys are much faster than a traditional app server, so for all but the largest
applications this should take well under a second. This greatly speeds up a developer's development cycle.

Kogito provides support for not only hot-reloading source code, but also business assets, like BPMN2 process definitions, DMN decision definitions, DRL rule files, Excel-based decision tables. This makes Kogito and its supported resources a first-class-citizen in the Quarkus eco-system.

In this part of the lab, we will experience the _hot-reload_ semantics of Kogito by altering the rules of our _Kogito Travel Agency_ application.

. From the `/home/lab-user/kogito-travel-agency-tutorial` folder, navigate to the `01-kogito-travel-agency` folder.
+
----
$ cd 01-kogito-travel-agency
----
+
. Run the Maven command to start the Kogito application in _dev-mode_.
+
----
$ mvn clean package quarkus:dev
----
+
. If everything executed correctly, you will now see the application running in _dev-mode_.
+
----
[INFO] --- quarkus-maven-plugin:0.20.0:dev (default-cli) @ kogito-travel-agency ---
Listening for transport dt_socket at address: 5005
2019-08-23 11:19:53,578 INFO  [io.qua.dep.QuarkusAugmentor] (main) Beginning quarkus augmentation
2019-08-23 11:20:00,485 INFO  [io.qua.dep.QuarkusAugmentor] (main) Quarkus augmentation completed in 6907ms
2019-08-23 11:20:00,878 INFO  [io.qua.swa.run.SwaggerUiServletExtension] (main) Swagger UI available at /swagger-ui
2019-08-23 11:20:01,515 INFO  [io.quarkus] (main) Quarkus 0.20.0 started in 8.297s. Listening on: http://[::]:8080
2019-08-23 11:20:01,542 INFO  [io.quarkus] (main) Installed features: [cdi, kogito, resteasy, resteasy-jsonb, smallrye-openapi, swagger-ui]
----
+

We can see that the applications has a number of features installed, including _kogito_ to provide intelligent business application support, _resteasy_ to provide RESTful support, and _swagger-ui_ to provide swagger support.

Let's first access the application via the provided user interface.

. On your laptop, open a browser (Chrome, Firefox) and navigate to your workstation at: http://workstation-$GUID.rhpds.opentlc.com:8080 (replace $GUID with the GUID provided to you)
. You will see the following application UI.
image:images/kogito-travel-agency-ui-home.png[]

First we want to explore the semantic of our service. As we can see in the process diagram, the first node that is executed is _Business Rules_ node.

image:images/travels-process.png[]

This node executes the rules that determine whether an booking requires a visa or not. The rules can be found in the `visa-rules.drl` file located in the package `org.acme.travels` in the `src/main/resources` folder of the project.
Let's take a quick look at the rules:

----
rule "Polish citizens require visa to US"
	ruleflow-group "visas"
	when
		$trip: Trip($trip.country == "US")
		$traveller : Traveller($traveller.nationality == "Polish")
	then
		$trip.setVisaRequired( true );
end

rule "Polish citizens do not require visa to UK"
	ruleflow-group "visas"
	when
		$trip: Trip($trip.country == "UK")
		$traveller : Traveller($traveller.nationality == "Polish")
	then
		$trip.setVisaRequired( false );
end

rule "Polish citizens require visa to Australia"
	ruleflow-group "visas"
	when
		$trip: Trip($trip.country == "Australia")
		$traveller : Traveller($traveller.nationality == "Polish")
	then
		$trip.setVisaRequired( true );
end
----

What we can see is that, depending on the destination country, a `Traveller` from Poland either requires a visa or not. In this lab we will change one of these rules to demonstrate the _hot-reload_ functionality.

. Open the UI of the application and click on the blue _"+ Plan new trip"_ button.
. In the form, enter the following values and click on the blue _"Book your trip"_ button:
* Traveller:
** First Name: "Jan"
** Last Name: "Kowalski"
** Email: "jan.kowalski@example.com"
** Nationality: "Polish"
** Street: "Polna"
** City: "Krakow"
** Zip code: "32000"
** Country: "Poland"
* Trip:
** Country: "Australia"
** City: "Brisbane"
** Begin at: "2019-09-22"
** End at: "2019-09-27"
+
image:images/booking-with-visa.png[]
+
. A new entry should appear in the list of travels. The entry shows that a visa is required, indicating that the business rules have determined that a traveller from Poland travelling to Australia requires a visa.
+
image:images/travels-list.png[]
+
. Click on the _"Tasks"_ button. A task named _"Visa Application"_ should appear.
+
image:images/visa-application-task.png[]
+
Let's now change this rule in such a way that a traveller from Poland does *not* require a visa when travelling to Australia. We will change the rule in our _DRL_ file and demonstrate the _hot-reload_ feature of Kogito.
+
. Open a new SSH session to your workstation. This allows us to change one of our source files, while we keep our application running in _dev-mode_ in our other terminal.
+
----
$ export GUID=<your GUID obtained from the GuidGrabber>
$ ssh lab-user@workstation-$GUID.rhpds.opentlc.com
----
* When prompted, enter the password provided by the instructor.
. Navigate to the project folder:
+
----
$ cd kogito-travel-agency-tutorial/01-kogito-travel-agency
----
. Open the `visa-rules.drl` file using VIM
+
----
$ vim src/main/resources/org/acme/travels/visa-rules.drl
----
+
. Navigate to the rule with the name _"Polish citizens require visa to Australia"_ and change the `then` (the rule consequence) in such a way that no visa is required:
+
[subs="quotes"]
----
rule "Polish citizens require visa to Australia"
  ruleflow-group "visas"
when
  $trip: Trip($trip.country == "Australia")
  $traveller : Traveller($traveller.nationality == "Polish")
then
  *$trip.setVisaRequired( false );*
end
----
+
. Save and exit by pressing `:wq` and `Enter`.
. In the application UI, create a new booking with the exact same data as the previous one. Observe that no visa is required.
image:images/booking-without-visa-hot-reload.png[]
. Go to the SSH terminal in which the application is running. The log will show that a change in the _DRL_ file was detected and Quarkus/Kogito reloaded the application:
+
----
2019-08-23 13:40:57,170 INFO  [io.qua.dev] (executor-thread-1) Changed source files detected, recompiling [/home/lab-user/kogito-travel-agency-tutorial/01-kogito-travel-agency/src/main/resources/org/acme/travels/visa-rules.drl]
2019-08-23 13:40:58,328 INFO  [io.quarkus] (executor-thread-1) Quarkus stopped in 0.001s
2019-08-23 13:40:58,336 INFO  [io.qua.dep.QuarkusAugmentor] (executor-thread-1) Beginning quarkus augmentation
2019-08-23 13:40:58,678 INFO  [io.qua.dep.QuarkusAugmentor] (executor-thread-1) Quarkus augmentation completed in 342ms
2019-08-23 13:40:58,725 INFO  [io.qua.swa.run.SwaggerUiServletExtension] (executor-thread-1) Swagger UI available at /swagger-ui
2019-08-23 13:40:58,779 INFO  [io.quarkus] (executor-thread-1) Quarkus 0.20.0 started in 0.451s. Listening on: http://[::]:8080
2019-08-23 13:40:58,780 INFO  [io.quarkus] (executor-thread-1) Installed features: [cdi, kogito, resteasy, resteasy-jsonb, smallrye-openapi, swagger-ui]
2019-08-23 13:40:58,780 INFO  [io.qua.dev] (executor-thread-1) Hot replace total time: 1.612s
----
+
. Stop the application by using `Ctrl+C`

We've seen the _hot-reload_ semantics of Kogito in action. Next we will look at how Kogito applications expose their RESTful API and how they adapt to your domain data.


== Lab 2: Domain Driven Business Applications

In previous versions of our Business Application platforms, the RESTful services always exposed generic RESTful APIs. An example of this was the commands-based API to invoke Drools Rules via KIE-Server, and the Map-based input parameters when starting a jBPM businesss process.

In Kogito, the exposed (RESTful) services are generated based on your domain data. In other words, Kogito adopts to your business domain rather than the other way around. This prevents the leaking of abstractions of the platform into your client applications and services and allows you to stay focused on the business and business domain instead of being concerned with the technology behind it.

Kogito accomplishes this by introspecting the business assets (process definitions, DRL, DMN, etc), and generating its remoting APIs based on the data-types and functionalities of your assets. This allows Kogito to expose domain specific APIs to its consumers.

A good way to demonstrate this is to inspect the Swagger documentation of our _Kogito Travel Agency_ application.

. With the _Kogito Travel Agency_ application still running, navigate to http://workstation-$GUID.rhpds.opentlc.com:8080/swagger-ui (replace $GUID with the GUID provided to you).
. Inspect the Swagger documentation. Note that the API defines RESTful resources like `Travel` and `VisaApplication` instead of `Process` and `Tasks`.
image:images/kogito-swagger.png[]

Travel request can be started via Swagger UI - using its "Try out" option. Locate `/travels` endpoint with `POST` method with following payload

----
{
	"traveller" : {
		"firstName" : "Jan",
		"lastName" : "Kowalski",
		"email" : "jan.kowalski@example.com",
		"nationality" : "Polish",
		"address" : {
			"street" : "polna",
			"city" : "Krakow",
			"zipCode" : "32000",
			"country" : "Poland"
		}
	},
	"trip" : {
		"city" : "New York",
		"country" : "US",
		"begin" : "2019-12-10T00:00:00.000+02:00",
		"end" : "2019-12-15T00:00:00.000+02:00"
	}
}
----

This will initiate new travel request which should be directly visible in the UI of the Kogito Travel Agency.

== Lab 3: Kogito Persistence

Kogito supports a runtime persistence for workflows. That allows users to configure key value based storage backed by Infinispan to persist data (including active nodes and process instance variables) to preserve it across restarts.

Runtime persistence focuses mainly on storing data that are required to resume workflow execution for particular process instance. Regardless if the process is public or provide as long as it’s not completed it subject for persistence.

*Node instances*

Node instances that are currently active, so called wait states, are persisted when process instance finished execution but have not reached end state (completed or aborted). This means that only information required to resume are persisted. There might be one or more active nodes instances stored at any given point in time.

*Process instance variables*

All data that are included in the process instance are stored together with the process instance itself. These must be marshalled into a bytes format so it can be easily transferred over the wire and persisted into the key value storage. The marshalling and unmarshalling is implemented based on ProtoBuf and requires to have schema and marshallers available to know how to deal with given type of data.

In this section of the lab we will use the `02-kogito-travel-agency` project, which is the same project as used in the previous lab, but this time with persistence enabled. We use _Infinispan_ as persistent data store for process data. +
In the lab we will deploy the application to OpenShift. We will also build and deploy a native image to OpenShift.

=== Local test of the application

. From the `/home/lab-user/kogito-travel-agency-tutorial` folder, navigate to the `02-kogito-travel-agency` folder.
+
----
$ cd 02-kogito-travel-agency
----
. Inspect the POM file of the project. Take note of the dependencies to `io.quarkus:quarkus-infinispan-client` and `org.kie.kogito:infinispan-persistence-addon`. This is all it takes to enable persistence using Infinispan.
. Inspect the contents of `src/main/resources/application.properties`.
+
----
quarkus.infinispan-client.server-list=localhost:11222
----
+
The `quarkus.infinispan-client.server-list` entry defines the list of Infinispan servers for the Quarkus Infinispan client to connect to upon startup. The Quarkus Infinispan client uses the _Infinispan Hot Rod_ protocol to connect to a remote Infinispan server.
. Start a local instance of Infinispan on the lab workstation using Podman. +
Open a new terminal, ssh into the workstation as user `lab-user`, and run the following commands:
+
----
$ sudo podman run -it -p 11222:11222 jboss/infinispan-server:10.0.0.Beta3
----
+
Let the Infinispan server start up. After a couple of seconds you will see the following output:
+
----
05:25:15,708 INFO  [org.jboss.as] (Controller Boot Thread) WFLYSRV0025: Infinispan Server 10.0.0.Beta3 (WildFly Core 6.0.2.Final) started in 5484ms - Started 227 of 275 services (133 services are lazy, passive or on-demand)
----
. Run the Kogito Travel Agency app in _dev mode_:
+
----
$ mvn clean compile quarkus:dev
----
+
.Output
----
2019-08-25 07:35:10,384 INFO  [io.qua.swa.run.SwaggerUiServletExtension] (main) Swagger UI available at /swagger-ui
2019-08-25 07:35:10,937 INFO  [org.inf.cli.hot.imp.pro.Codec] (HotRod-client-async-pool-1-1) ISPN004006: Server sent new topology view (id=1, age=0) containing 1 addresses: [172.17.42.3:11222]
2019-08-25 07:35:10,940 INFO  [org.inf.cli.hot.imp.tra.net.ChannelFactory] (HotRod-client-async-pool-1-1) ISPN004014: New server added(172.17.42.3:11222), adding to the pool.
2019-08-25 07:35:10,943 INFO  [org.inf.cli.hot.imp.tra.net.ChannelFactory] (HotRod-client-async-pool-1-1) ISPN004016: Server not in cluster anymore(localhost:11222), removing from the pool.
2019-08-25 07:35:11,022 INFO  [org.inf.cli.hot.RemoteCacheManager] (main) ISPN004021: Infinispan version: 10.0.0.Beta5
2019-08-25 07:35:11,045 INFO  [org.inf.cli.hot.imp.pro.Codec] (HotRod-client-async-pool-1-2) ISPN004006: Server sent new topology view (id=1, age=0) containing 1 addresses: [172.17.42.3:11222]
2019-08-25 07:35:11,225 INFO  [io.quarkus] (main) Quarkus 999-SNAPSHOT started in 5.081s. Listening on: http://0.0.0.0:8080
2019-08-25 07:35:11,225 INFO  [io.quarkus] (main) Installed features: [cdi, infinispan-client, kogito, resteasy, resteasy-jsonb, smallrye-health, smallrye-openapi, swagger-ui, vertx, vertx-web]
----
+
Note that the application successfully discovered the Infinispan server.
. Check the logs of the Infinispan server. Note the following output:
+
----
05:35:11,172 INFO  [org.jboss.as.clustering.infinispan] (async-thread--p6-t1) DGISPN0001: Started travels_store ca
che from clustered container
05:35:11,203 INFO  [org.jboss.as.clustering.infinispan] (async-thread--p6-t2) DGISPN0001: Started flightBooking_st
ore cache from clustered container
05:35:11,219 INFO  [org.jboss.as.clustering.infinispan] (async-thread--p6-t3) DGISPN0001: Started hotelBooking_sto
re cache from clustered container
----
. Create a couple of travel requests using the application UI or the Swagger UI.
. Press `Ctrl-C` to shut down the application. Keep the Infinispan server running. Start the application again in _dev mode_. Notice that the travel requests are still present.
. At this point feel free to shut down both the application as the Infinispan server.

=== Deployment to OpenShift - JVM mode

. From the lab workstation, login into the OpenShift cluster using the `oc` utility as `user1`:
+
----
$ oc login -u user1 https://master00.example.com -u user1
----
. Create a project for the Kogito Travel Agency application
+
----
$ oc new-project kogito
----
. Give the default service account `view` privileges in the project:
+
----
$ oc adm policy add-role-to-user view -z default -n kogito
----
. The `openshift` folder of the `02-kogito-travel-agency` project contains a OpenShift template file for an Infinispan deployment. It will create a minimal Infinispan deployment, consisting of 1 node, with disabled security,and  exposing a Hot Rod endpoint on port 11222. To deploy Infinispan on your OpenShift cluster:
+
----
$ oc process -f openshift/infinispan-server.yml | oc create -f - -n kogito
----
. Follow the deployment of the Infinispan server on the OpenShift console, or use `oc`:
+
----
$ oc get pods -w
----
+
.Output
----
NAME                                 READY     STATUS              RESTARTS   AGE
infinispan-server-656b846c7c-rgz8z   0/1       ContainerCreating   0          6s
infinispan-server-656b846c7c-rgz8z   0/1       Running   0         35s
infinispan-server-656b846c7c-rgz8z   1/1       Running   0         1m
----

. By default, the Kogito Travel Agency app will try to connect to a Infinispan server on `localhost:11222`. When deploying on OpenShift, we need to configure the application to connect a remote Infinispan instance. To override the default configuration properties we can use a ConfigMap containing an `application.properties` file which will be mounted inside the application pod.
.. On the lab workstation, create a file `/tmp/application.properties`.
+
----
$ touch /tmp/application.properties
----
+
Using `vim`, add the following content to the file:
+
----
quarkus.infinispan-client.server-list=infinispan-server.kogito.svc:11222
----

.. Create a ConfigMap from the `application.properties` file:
+
----
$ oc create configmap kogito-travel-agency --from-file=/tmp/application.properties -n kogito
----

. The `openshift` folder of the `02-kogito-travel-agency` project contains a OpenShift template file for a binary deployment of the Kogito Travel Agency app. It describes a BuildConfig, ImageStream, DeploymentConfig, Service and Route for the application. In this lab, we will deploy the application itself usng a binary build from the lab workstation. +
Review the `kogito-travel-agency.yml` template file.
+
* We use the `redhat-openjdk18-openshift` image as a builder image. In JVM mode the application requires a JVM to run.
* The `kogito-travel-agency` ConfigMap is mounted in the `/deployments/config` directory of the pod.

. Deploy the template to the OpenShift cluster:
+
----
$ oc process -f openshift/kogito-travel-agency.yml | oc create -f - -n kogito
----
+
.Output
----
service/kogito-travel-agency created
route.route.openshift.io/kogito-travel-agency created
deploymentconfig.apps.openshift.io/kogito-travel-agency created
buildconfig.build.openshift.io/kogito-travel-agency created
imagestream.image.openshift.io/kogito-travel-agency created
----

. On the lab workstation, build the Kogito Travel Agency app:
+
----
$ mvn clean package -DskipTests=true
----
+
The project unit tests require a running local Infinispan instance, so we can skip them.

. Inspect the `target` folder of the project:
+
----
$ ls target
----
+
----
drwxrwxr-x. 5 lab-user lab-user   4096 Aug 25 08:41 classes
drwxrwxr-x. 4 lab-user lab-user   4096 Aug 25 08:41 generated-sources
drwxrwxr-x. 3 lab-user lab-user   4096 Aug 25 08:41 generated-test-sources
-rw-rw-r--. 1 lab-user lab-user     60 Aug 25 08:41 image_metadata.json
-rw-rw-r--. 1 lab-user lab-user  21688 Aug 25 08:41 kogito-travel-agency-1.0-SNAPSHOT.jar
-rw-r--r--. 1 lab-user lab-user 371650 Aug 25 08:41 kogito-travel-agency-1.0-SNAPSHOT-runner.jar
drwxrwxr-x. 2 lab-user lab-user  20480 Aug 25 08:41 lib
drwxrwxr-x. 2 lab-user lab-user   4096 Aug 25 08:41 maven-archiver
drwxrwxr-x. 3 lab-user lab-user   4096 Aug 25 08:41 maven-status
drwxrwxr-x. 3 lab-user lab-user   4096 Aug 25 08:41 test-classes
drwxrwxr-x. 2 lab-user lab-user   4096 Aug 25 08:41 transformed-classes
drwxrwxr-x. 6 lab-user lab-user   4096 Aug 25 08:41 wiring-classes
----
+
`kogito-travel-agency-1.0-SNAPSHOT-runner.jar` is a executable JAR file. It is however not an _uber-jar_ as the dependencies are copied into the target/lib directory.

. Prepare for a binary build on OpenShift.
On your workstation, create a directory `/tmp/kogito-travel-agency`. Copy the executable application jar and the lib folder to the directory.
+
----
$ mkdir /tmp/kogito-travel-agency
$ cp -r target/kogito-travel-agency-1.0-SNAPSHOT-runner.jar target/lib /tmp/kogito-travel-agency
----

. Deploy the application to OpenShift:
+
----
$ oc start-build kogito-travel-agency --from-dir=/tmp/kogito-travel-agency -n kogito
----
+
----
Uploading directory "/tmp/kogito-travel-agency" as binary input for the build ...
...........
Uploading finished
build.build.openshift.io/kogito-travel-agency-1 started
----
. Check the logs of the builder pod:
+
----
$ oc logs kogito-travel-agency-1-build -n kogito
----
+
----
Using docker-registry.default.svc:5000/openshift/redhat-openjdk18-openshift@sha256:dc84fed0f6f40975a2277c126438c8aa15c70eeac75981dbaa4b6b853eff61a6 as the s2i builder image
==================================================================
Starting S2I Java Build .....
S2I source build with plain binaries detected
Copying binaries from /tmp/src to /deployments ...
... done

Pushing image docker-registry.default.svc:5000/kogito-travel-agency/kogito-travel-agency:latest ...
Pushed 1/6 layers, 18% complete
Pushed 2/6 layers, 39% complete
Pushed 3/6 layers, 64% complete
Pushed 4/6 layers, 84% complete
Pushed 5/6 layers, 94% complete
Pushed 6/6 layers, 100% complete
Push successful
----
. Check the logs of the application pod:
+
----
Starting the Java application using /opt/run-java/run-java.sh ...
exec java -javaagent:/opt/jolokia/jolokia.jar=config=/opt/jolokia/etc/jolokia.properties -Xms63m -Xmx250m -XX:+UnlockExperimentalVMOptions -XX:+UseCGroupMemoryLimitForHeap -XX:+UseParallelOldGC -XX:MinHeapFreeRatio=10 -XX:MaxHeapFreeRatio=20 -XX:GCTimeRatio=4 -XX:AdaptiveSizePolicyWeight=90 -XX:MaxMetaspaceSize=100m -XX:ParallelGCThreads=1 -Djava.util.concurrent.ForkJoinPool.common.parallelism=1 -XX:CICompilerCount=2 -XX:+ExitOnOutOfMemoryError -cp . -jar /deployments/kogito-travel-agency-1.0-SNAPSHOT-runner.jar
I> No access restrictor found, access to any MBean is allowed
Jolokia: Agent started with URL https://10.128.0.180:8778/jolokia/
2019-08-25 06:57:22,237 INFO  [org.inf.cli.hot.imp.pro.Codec] (HotRod-client-async-pool-1-1) ISPN004006: Server sent new topology view (id=1, age=0) containing 1 addresses: [10.128.0.176:11222]
2019-08-25 06:57:22,246 INFO  [org.inf.cli.hot.imp.tra.net.ChannelFactory] (HotRod-client-async-pool-1-1) ISPN004014: New server added(10.128.0.176:11222), adding to the pool.
2019-08-25 06:57:22,248 INFO  [org.inf.cli.hot.imp.tra.net.ChannelFactory] (HotRod-client-async-pool-1-1) ISPN004016: Server not in cluster anymore(infinispan-server.kogito-travel-agency.svc:11222), removing from the pool.
2019-08-25 06:57:22,266 INFO  [org.inf.cli.hot.RemoteCacheManager] (main) ISPN004021: Infinispan version: 10.0.0.Beta5
2019-08-25 06:57:22,937 INFO  [org.inf.cli.hot.imp.pro.Codec] (HotRod-client-async-pool-1-1) ISPN004006: Server sent new topology view (id=1, age=0) containing 1 addresses: [10.128.0.176:11222]
2019-08-25 06:57:24,361 INFO  [io.quarkus] (main) Quarkus 999-SNAPSHOT started in 16.820s. Listening on: http://0.0.0.0:8080
2019-08-25 06:57:24,362 INFO  [io.quarkus] (main) Installed features: [cdi, infinispan-client, kogito, resteasy, resteasy-jsonb, smallrye-health, smallrye-openapi, vertx, vertx-web]
----
+
Notice that the application starts up in about 15 seconds. The pod takes more or less 300MB of memory.


. Test the Kogito Travel Agency application using the application UI or the Swagger UI.
+
----
http://kogito-travel-agency-kogito.apps-<GUID>.generic.opentlc.com
----
+
----
http://kogito-travel-agency-kogito.apps-<GUID>.generic.opentlc.com/swagger-ui/
----

=== Deployment to OpenShift - Native image

. Build a Linux 64-bit native executable of the Kogito Travel Agency application:
+
----
$ mvn clean package -DskipTests=true -Pnative
----
+
* This produces a native executable `kogito-travel-agency-1.0-SNAPSHOT-runner` in the `target` folder of the project. Note that this executable only runs on 64-bit Linux.
Native compilation may take 5-10 minutes to complete.
* Sample output:
+
----
[INFO] Scanning for projects...
[INFO]
[INFO] ---------------< org.acme.travels:kogito-travel-agency >----------------
[INFO] Building kogito-travel-agency 1.0-SNAPSHOT
[INFO] --------------------------------[ jar ]---------------------------------
[INFO]
[INFO] --- maven-clean-plugin:2.5:clean (default-clean) @ kogito-travel-agency ---
[INFO] Deleting /home/bernard/projects_internal/rhte2019-kogito/kogito-travel-agency-2/target
[INFO]
[INFO] --- maven-resources-plugin:2.6:resources (default-resources) @ kogito-travel-agency ---
[INFO] Using 'UTF-8' encoding to copy filtered resources.
[INFO] Copying 6 resources
[INFO]
[INFO] --- maven-compiler-plugin:3.1:compile (default-compile) @ kogito-travel-agency ---
[INFO] Changes detected - recompiling the module!
[INFO] Compiling 10 source files to /home/bernard/projects_internal/rhte2019-kogito/kogito-travel-agency-2/target/classes
[INFO]
[INFO] --- maven-resources-plugin:2.6:testResources (default-testResources) @ kogito-travel-agency ---
[INFO] Using 'UTF-8' encoding to copy filtered resources.
[INFO] skip non existing resourceDirectory /home/bernard/projects_internal/rhte2019-kogito/kogito-travel-agency-2/src/test/resources
[INFO]
[INFO] --- maven-compiler-plugin:3.1:testCompile (default-testCompile) @ kogito-travel-agency ---
[INFO] Changes detected - recompiling the module!
[INFO] Compiling 4 source files to /home/bernard/projects_internal/rhte2019-kogito/kogito-travel-agency-2/target/test-classes
[INFO]
[INFO] --- maven-surefire-plugin:2.22.0:test (default-test) @ kogito-travel-agency ---
[INFO] Tests are skipped.
[INFO]
[INFO] --- maven-jar-plugin:2.4:jar (default-jar) @ kogito-travel-agency ---
[INFO] Building jar: /home/bernard/projects_internal/rhte2019-kogito/kogito-travel-agency-2/target/kogito-travel-agency-1.0-SNAPSHOT.jar
[INFO]
[INFO] --- quarkus-maven-plugin:999-SNAPSHOT:build (default) @ kogito-travel-agency ---
[INFO] [io.quarkus.deployment.QuarkusAugmentor] Beginning quarkus augmentation
[INFO] [org.jboss.threads] JBoss Threads version 3.0.0.Beta5
[INFO] [io.quarkus.deployment.QuarkusAugmentor] Quarkus augmentation completed in 4915ms
[INFO] [io.quarkus.creator.phase.runnerjar.RunnerJarPhase] Building jar: /home/bernard/projects_internal/rhte2019-kogito/kogito-travel-agency-2/target/kogito-travel-agency-1.0-SNAPSHOT-runner.jar
[INFO]
[INFO] --- quarkus-maven-plugin:999-SNAPSHOT:native-image (default) @ kogito-travel-agency ---
[INFO] [io.quarkus.creator.phase.nativeimage.NativeImagePhase] Running Quarkus native-image plugin on OpenJDK 64-Bit Server VM
[INFO] [io.quarkus.creator.phase.nativeimage.NativeImagePhase] /home/bernard/apps/graalvm/current/bin/native-image -J-Djava.util.logging.manager=org.jboss.logmanager.LogManager -J-Dio.netty.leakDetection.level=DISABLED -J-Dvertx.disableDnsResolver=true -J-Dio.netty.noUnsafe=true --
initialize-at-build-time= -H:InitialCollectionPolicy=com.oracle.svm.core.genscavenge.CollectionPolicy$BySpaceAndTime -jar kogito-travel-agency-1.0-SNAPSHOT-runner.jar -J-Djava.util.concurrent.ForkJoinPool.common.parallelism=1 -H:FallbackThreshold=0 -H:+ReportExceptionStackTraces -H
:+PrintAnalysisCallTree -H:-AddAllCharsets -H:EnableURLProtocols=http,https --enable-all-security-services -H:NativeLinkerOption=-no-pie -H:-SpawnIsolates -H:+JNI --no-server -H:-UseServiceLoaderFeature -H:+StackTrace
[kogito-travel-agency-1.0-SNAPSHOT-runner:18704]    classlist:  20,599.62 ms
[kogito-travel-agency-1.0-SNAPSHOT-runner:18704]        (cap):   1,282.78 ms
[kogito-travel-agency-1.0-SNAPSHOT-runner:18704]        setup:   2,839.74 ms
12:07:05,137 INFO  [org.jbo.threads] JBoss Threads version 3.0.0.Beta5
[...]
[kogito-travel-agency-1.0-SNAPSHOT-runner:18704]   (typeflow):  33,347.24 ms
[kogito-travel-agency-1.0-SNAPSHOT-runner:18704]    (objects):  17,013.88 ms
[kogito-travel-agency-1.0-SNAPSHOT-runner:18704]   (features):     958.93 ms
[kogito-travel-agency-1.0-SNAPSHOT-runner:18704]     analysis:  55,337.70 ms
Printing call tree to /home/bernard/projects_internal/rhte2019-kogito/kogito-travel-agency-2/target/reports/call_tree_kogito-travel-agency-1.0-SNAPSHOT-runner_20190825_120813.txt
Printing list of used classes to /home/bernard/projects_internal/rhte2019-kogito/kogito-travel-agency-2/target/reports/used_classes_kogito-travel-agency-1.0-SNAPSHOT-runner_20190825_120819.txt
Printing list of used packages to /home/bernard/projects_internal/rhte2019-kogito/kogito-travel-agency-2/target/reports/used_packages_kogito-travel-agency-1.0-SNAPSHOT-runner_20190825_120819.txt
[kogito-travel-agency-1.0-SNAPSHOT-runner:18704]     (clinit):   1,180.92 ms
[kogito-travel-agency-1.0-SNAPSHOT-runner:18704]     universe:   3,353.74 ms
[kogito-travel-agency-1.0-SNAPSHOT-runner:18704]      (parse):   4,563.41 ms
[kogito-travel-agency-1.0-SNAPSHOT-runner:18704]     (inline):   6,275.42 ms
[kogito-travel-agency-1.0-SNAPSHOT-runner:18704]    (compile):  54,221.94 ms
[kogito-travel-agency-1.0-SNAPSHOT-runner:18704]      compile:  68,186.55 ms
[kogito-travel-agency-1.0-SNAPSHOT-runner:18704]        image:   6,117.41 ms
[kogito-travel-agency-1.0-SNAPSHOT-runner:18704]        write:   1,038.32 ms
[kogito-travel-agency-1.0-SNAPSHOT-runner:18704][total]: 179,075.43 ms
[INFO] ------------------------------------------------------------------------
[INFO] BUILD SUCCESS
[INFO] ------------------------------------------------------------------------
[INFO] Total time: 03:09 min
[INFO] Finished at: 2019-08-25T12:09:39+02:00
[INFO] ------------------------------------------------------------------------
----
. Optional: run and test the application locally. Make sure to start the Infinispan docker image first.
+
----
$ ./target/kogito-travel-agency-1.0-SNAPSHOT-runner
----
+
.Output
----
2019-08-25 12:33:21,676 INFO  [org.inf.cli.hot.imp.pro.Codec] (HotRod-client-async-pool-1-1) ISPN004006: Server sent new topology view (id=1, age=0) containing 1 addresses: [172.17.42.3:11222]
2019-08-25 12:33:21,676 INFO  [org.inf.cli.hot.imp.tra.net.ChannelFactory] (HotRod-client-async-pool-1-1) ISPN004014: New server added(172.17.42.3:11222), adding to the pool.
2019-08-25 12:33:21,676 INFO  [org.inf.cli.hot.imp.tra.net.ChannelFactory] (HotRod-client-async-pool-1-1) ISPN004016: Server not in cluster anymore(localhost:11222), removing from the pool.
2019-08-25 12:33:21,677 INFO  [org.inf.cli.hot.RemoteCacheManager] (main) ISPN004021: Infinispan version: null
2019-08-25 12:33:21,711 INFO  [org.inf.cli.hot.imp.pro.Codec] (HotRod-client-async-pool-1-3) ISPN004006: Server sent new topology view (id=1, age=0) containing 1 addresses: [172.17.42.3:11222]
2019-08-25 12:33:21,886 INFO  [io.quarkus] (main) Quarkus 999-SNAPSHOT started in 0.307s. Listening on: http://0.0.0.0:8080
2019-08-25 12:33:21,887 INFO  [io.quarkus] (main) Installed features: [cdi, infinispan-client, kogito, resteasy, resteasy-jsonb, smallrye-health, smallrye-openapi, swagger-ui, vertx, vertx-web]
----

. Build a Docker image with the native executable. The `src/main/docker` folder contains a Docker file based on a minimal RHEL8 UBI image. Build the Docker image using Podman:
+
----
$ sudo podman build -f src/main/docker/Dockerfile.native -t kogito-travel-agency:0.0.1 .
----
+
.Sample output
----
STEP 1: FROM registry.access.redhat.com/ubi8/ubi-minimal
Getting image source signatures
Copying blob e9152ec084c2 done
Copying blob 9b3f8c4ce518 done
Copying config 9c9faa7498 done
Writing manifest to image destination
Storing signatures
STEP 2: WORKDIR /work/
59898364eb11211127a646b625d9ec0edbb6afbbc20bc72ab543bb2f3d2ae92c
STEP 3: COPY target/*-runner /work/application
f081443003d57c8114d5f47fd1f82f118c4322bc640ea28bd1932cea731224b0
STEP 4: RUN chmod 775 /work
4c0ab746913f8021870046abe02c0e9951b60e625145968d8695ec1bb834dfa6
STEP 5: EXPOSE 8080
458dae96b2e69fd556342d37a50259552a2727ea2a9203928afc330f254ebd14
STEP 6: CMD ["./application", "-Dquarkus.http.host=0.0.0.0"]
STEP 7: COMMIT kogito-travel-agency:0.0.1
57c04fae486399869aeadba8fe7ac5dc1cd402c5d56cca290f025b86833a02b1
----

. Push the native image to the internal Docker registry of the OpenShift cluster.
.. Log in into the cluster as user `admin`. Use the same password as `user1`.
+
----
$ oc login -u admin
----
.. Create a public route to the docker registry in the `default` namespace.
+
----
$ oc create route passthrough docker-registry-lab --service=docker-registry -n default
----
.. Set the route to the docker registry as an environment variable.
+
----
$ export DOCKER_REGISTRY_HOSTNAME=$(oc get route docker-registry-lab -n default -o template --template='{{.spec.host}}')
----
.. Login to the internal registry of your OpenShift cluster.
+
----
$ export TKN=`oc whoami -t`
$ sudo podman login -u admin -p $TKN --tls-verify=false $DOCKER_REGISTRY_HOSTNAME
----
.. Tag the image
+
----
$ sudo podman tag kogito-travel-agency:0.0.1  $DOCKER_REGISTRY_HOSTNAME/openshift/kogito-travel-agency:0.0.1
----
.. Push the image to the OpenShift registry:
+
----
$ sudo podman push $DOCKER_REGISTRY_HOSTNAME/openshift/kogito-travel-agency:0.0.1 --tls-verify=false
----
.. Log back in as `user1`.
+
----
$ oc login -u user1
----

. Scale down the non-native version of the Kogito Travel Agency application:
+
----
$ oc scale dc kogito-travel-agency --replicas=0 -n kogito
----

. The `openshift` folder of the `02-kogito-travel-agency` project contains a OpenShift template file for a deployment of the native version of the Kogito Travel Agency app. It describes a DeploymentConfig, Service and Route for the application. +
Review the `kogito-travel-agency-native.yml` template file.
+
* The DeploymentConfig points to the imagestream of the image we pushed to the OpenShift registry.
* The `kogito-travel-agency` ConfigMap is mounted in the `/work/config` directory of the pod.

. Deploy the template to the OpenShift cluster:
+
----
$ oc process -f openshift/kogito-travel-agency-native.yml | oc create -f - -n kogito
----
+
.Output
----
service/kogito-travel-agency-native created
route.route.openshift.io/kogito-travel-agency-native created
deploymentconfig.apps.openshift.io/kogito-travel-agency-native created
----

. Check the logs of the application pod:
+
----
019-08-25 17:37:56,974 INFO  [org.inf.cli.hot.imp.pro.Codec] (HotRod-client-async-pool-1-1) ISPN004006: Server sent new topology view (id=1, age=0) containing 1 addresses: [10.128.0.195:11222]
2019-08-25 17:37:56,975 INFO  [org.inf.cli.hot.imp.tra.net.ChannelFactory] (HotRod-client-async-pool-1-1) ISPN004014: New server added(10.128.0.195:11222), adding to the pool.
2019-08-25 17:37:56,975 INFO  [org.inf.cli.hot.imp.tra.net.ChannelFactory] (HotRod-client-async-pool-1-1) ISPN004016: Server not in cluster anymore(infinispan-server.kogito-travel-agency.svc:11222), removing from the pool.
2019-08-25 17:37:56,977 INFO  [org.inf.cli.hot.RemoteCacheManager] (main) ISPN004021: Infinispan version: null
2019-08-25 17:37:57,087 INFO  [org.inf.cli.hot.imp.pro.Codec] (HotRod-client-async-pool-1-2) ISPN004006: Server sent new topology view (id=1, age=0) containing 1 addresses: [10.128.0.195:11222]
2019-08-25 17:37:57,296 INFO  [io.quarkus] (main) Quarkus 999-SNAPSHOT started in 0.486s. Listening on: http://0.0.0.0:8080
2019-08-25 17:37:57,297 INFO  [io.quarkus] (main) Installed features: [cdi, infinispan-client, kogito, resteasy, resteasy-jsonb, smallrye-health, smallrye-openapi, swagger-ui, vertx, vertx-web]
----
+
Notice that the application starts up in about 0.5 seconds. The pod takes more or less 80MB of memory.

. Test the Kogito Travel Agency native application using the application UI or the Swagger UI.

== Lab 4: Event Driven Kogito with Kafka

Events are first class citizens in Kogito. The runtime emits events based on the execution context of given request. The main aim for these events is to notify 3rd parties about changes to the process instance and its data. To avoid too many events being sent and to optimise both producer and consumer side there will be only one event per process instance emitted.
That event will consists of relevant information such as:

* process instance metadata e.g. process id, process instance id, process instance state, etc
* node instances executed, list of all node instances that have been triggered/left during the execution
* variables - current state of variables after the execution

These events will provide complete view over the process instances being executed.

The event format follows the CloudEvents (https://cloudevents.io) specification.

Events by default are only emitted when there is at least on publisher defined. There might be many event publishers that can be used to send/publish these events into different channels etc.

Out of the box Kogito ships with an event publisher using Quarkus Reactive Messaging - which allows to send events to Kafka, AMQP, MQTT, Camel.

Another use case for events is communication between process instances. The BPMN Message Event nodes in the Kogito runtime publish and consume messages from Kafka topics.

In this lab you will explore the integration of Kogito with Kafka.

In the version of the Kogito Travel Agency appliction used in this lab the event publishing mechanism has been enabled and configured to send events to a Kafka queue.

The Kogito travel booking process definition has been expanded to send a _VisaApplication_ object to a Kafka topic every time a traveler needs to apply for a visa. This is modeled with a BPMN _Message End Event_ node, where the _MessageEventDefinition_ corresponds to the name of the Quarkus messaging channel where the the message is sent to. The payload of the message (a `VisaApplication` object) is defined though a data input association.

image::images/travels-process-2.png[]

A second Kogito application - _Kogito Visas_ - has a process definition with a BPMN _Message Start Event_ mapped to the same Kafka topic. For every message consumed from the Kafka topic a new process instance will be created.

image::images/visa-applications-process.png[]

This version of the Kogito Travel Agency app is dependent on a running Kafka cluster. We could spin up a local containerized Kafka cluster, but for the sake of simplicity, we'll deploy the app directly to OpenShift, using a native image.

=== Kogito Travel Agency application

. From the `/home/lab-user/kogito-travel-agency-tutorial` folder, navigate to the `03-kogito-travel-agency` folder.
+
----
$ cd 03-kogito-travel-agency
----
. Create Kafka topics for the event publishing mechanism and the Kogito Travel Agency application. +
The event publishing mechanism uses a queue named `kogito-processinstances-events`. +
The Message End Node in de travel booking process is mapped to the queue `visaapplications`. +
The `openshift/kafka-topics.yml` in the project folder contains Custom Resource definitions for both queues. Create the CRs in the `kafka-cluster` namespace:
+
----
$ oc create -f openshift/kafka-topics.yml -n kafka-cluster
----
+
.Output
----
kafkatopic.kafka.strimzi.io/visaapplications created
kafkatopic.kafka.strimzi.io/kogito-processinstances-events created
----

. Create a new namespace `kogito2` for the Kogito Travel Agency application.
+
----
$ oc new-project kogito2
----

. The Kogito application is configured for persistence, so we need to deploy an Infinispan server:
+
----
$ oc process -f openshift/infinispan-server.yml | oc create -f - -n kogito2
----

. Review the `pom.xml` file of the application. Notice the dependencies to `org.kie.kogito:kogito-events-reactive-messaging-addon`, `io.quarkus:quarkus-kafka-client` and `io.quarkus:quarkus-smallrye-reactive-messaging-kafka` which are required for Kafka integration.

. Review the configuration file in `src/main/resources/application.properties`:
+
----
mp.messaging.outgoing.visaapplications.connector=smallrye-kafka
mp.messaging.outgoing.visaapplications.topic=visaapplications
mp.messaging.outgoing.visaapplications.value.serializer=org.acme.travels.json.VisaApplicationJsonbSerializer

mp.messaging.outgoing.kogito-processinstances-events.connector=smallrye-kafka
mp.messaging.outgoing.kogito-processinstances-events.topic=kogito-processinstances-events
mp.messaging.outgoing.kogito-processinstances-events.value.serializer=org.apache.kafka.common.serialization.StringSerializer
----
+
* The `mp.messaging.outgoing` entries map a Quarkus outgoing channel to the `smallrye-kafka` connector and the `visaapplications` and `kogito-processinstances-events` topics.

. Create a ConfigMap for the application to set the location of the Infinispan server and the Kafka broker for the messaging channels.
.. On the lab workstation, create a file `/tmp/application.properties`. Delete the existing file from the previous lab.
+
----
$ rm /tmp/application.properties
$ touch /tmp/application.properties
----
+
Using `vim`, add the following content to the file:
+
----
quarkus.infinispan-client.server-list=infinispan-server.kogito2.svc:11222

mp.messaging.outgoing.visaapplications.bootstrap.servers=kafka-cluster-kafka-bootstrap.kafka-cluster.svc:9092

mp.messaging.outgoing.kogito-processinstances-events.bootstrap.servers=kafka-cluster-kafka-bootstrap.kafka-cluster.svc:9092
----
.. Create a ConfigMap from the `application.properties` file:
+
----
$ oc create configmap kogito-travel-agency --from-file=/tmp/application.properties -n kogito2
----

. Build a Linux 64-bit native executable of the Kogito Travel Agency application:
+
----
$ mvn clean package -DskipTests=true -Pnative
----

. Build a Docker image with the native executable. The `src/main/docker` folder contains a Docker file based on a minimal RHEL8 UBI image. Build the Docker image using Podman. Tag the image as version `0.0.2` to differentiate from the version in the previous lab:
+
----
$ sudo podman build -f src/main/docker/Dockerfile.native -t kogito-travel-agency:0.0.2 .
----
. Follow the same steps as in the previous lab to push the native image to the OpenShift registry.
.. Tag the image
+
----
$ sudo podman tag kogito-travel-agency:0.0.2  $DOCKER_REGISTRY_HOSTNAME/openshift/kogito-travel-agency:0.0.2
----
.. Push the image to the OpenShift registry:
+
----
$ sudo podman push $DOCKER_REGISTRY_HOSTNAME/openshift/kogito-travel-agency:0.0.2 --tls-verify=false
----

. Deploy the Kogito Travel Agency application:
+
----
$ oc process -f openshift/kogito-travel-agency-native.yml | oc create -f - -n kogito2
----
+
.Output
----
service/kogito-travel-agency-native created
route.route.openshift.io/kogito-travel-agency-native created
deploymentconfig.apps.openshift.io/kogito-travel-agency-native created
----

=== Kogito Visas application

. From the `/home/lab-user/kogito-travel-agency-tutorial` folder, navigate to the `03-kogito-visas` folder.
+
----
$ cd 03-kogito-visas
----

. Review the configuration file in `src/main/resources/application.properties`:
+
----
mp.messaging.incoming.visaapplications.connector=smallrye-kafka
mp.messaging.incoming.visaapplications.topic=visaapplications
mp.messaging.incoming.visaapplications.value.deserializer=org.acme.travels.json.VisaApplicationJsonbDeserializer

mp.messaging.outgoing.kogito-processinstances-events.connector=smallrye-kafka
mp.messaging.outgoing.kogito-processinstances-events.topic=kogito-processinstances-events
mp.messaging.outgoing.kogito-processinstances-events.value.serializer=org.apache.kafka.common.serialization.StringSerializer
----
+
* The `mp.messaging.outgoing` entries map a Quarkus incoming channel to the `smallrye-kafka` connector and the `visaapplications` topic.
* The `mp.messaging.outgoing` entries map a Quarkus outgoing channel to the `smallrye-kafka` connector and the `kogito-processinstances-events` topic.

. Create a configmap for the application to set the location of the Infinispan server and the Kafka broker for the messaging channels.
.. On the lab workstation, create a file `/tmp/application.properties`. Delete the existing file from the previous lab.
+
----
$ rm /tmp/application.properties
$ touch /tmp/application.properties
----
+
Using `vim`, add the following content to the file:
+
----
quarkus.http.port=8080

quarkus.infinispan-client.server-list=infinispan-server.kogito2.svc:11222

mp.messaging.incoming.visaapplications.bootstrap.servers=kafka-cluster-kafka-bootstrap.kafka-cluster.svc:9092
mp.messaging.incoming.visaapplications.group.id=kogito-visa

mp.messaging.outgoing.kogito-processinstances-events.bootstrap.servers=kafka-cluster-kafka-bootstrap.kafka-cluster.svc:9092
----
.. Create a ConfigMap from the `application.properties` file:
+
----
$ oc create configmap kogito-visas --from-file=/tmp/application.properties -n kogito2
----

. Build a Linux 64-bit native executable of the Kogito Travel Agency application:
+
----
$ mvn clean package -DskipTests=true -Pnative
----

. Build a Docker image with the native executable. The `src/main/docker` folder contains a Docker file based on a minimal RHEL8 UBI image. Build the Docker image using Podman. Tag the image as version `0.0.1`:
+
----
$ sudo podman build -f src/main/docker/Dockerfile.native -t kogito-visas:0.0.1 .
----
. Follow the same steps as in the previous lab to push the native image to the OpenShift registry.
.. Tag the image
+
----
$ sudo podman tag kogito-visas:0.0.1  $DOCKER_REGISTRY_HOSTNAME/openshift/kogito-visas:0.0.1
----
.. Push the image to the OpenShift registry:
+
----
$ sudo podman push $DOCKER_REGISTRY_HOSTNAME/openshift/kogito-visas:0.0.1 --tls-verify=false
----

. Deploy the Kogito Visas application:
+
----
$ oc process -f openshift/kogito-visas-native.yml | oc create -f - -n kogito2
----
+
.Output
----
service/kogito-visas-native created
route.route.openshift.io/kogito-visas-native created
deploymentconfig.apps.openshift.io/kogito-visas-native created
----

=== Kafka Consumer application

The Kogito Travel Agency and Kogito Visas applications emit events to a Kafka queue whenever a new processinstance is created or its internal state changes. In order to observe these events, we deploy a simple native Quarkus application that consumes these events and prints its contents to _stdout_.

. From the `/home/lab-user/kogito-travel-agency-tutorial` folder, navigate to the `kafka-consuler` folder.
+
----
$ cd kafka-consumer
----

. Create a ConfigMap for the application to set the location of the Kafka broker and the topic to consume from.
.. On the lab workstation, create a file `/tmp/application.properties`. Delete the existing file from the previous lab.
+
----
$ rm /tmp/application.properties
$ touch /tmp/application.properties
----
+
Using `vim`, add the following content to the file:
+
----
mp.messaging.incoming.messages.bootstrap.servers=kafka-cluster-kafka-bootstrap.kafka-cluster.svc:9092
mp.messaging.incoming.messages.topic=kogito-processinstances-events
mp.messaging.incoming.messages.group.id=kafka-consumer
----
.. Create a ConfigMap from the `application.properties` file:
+
----
$ oc create configmap kafka-consumer --from-file=/tmp/application.properties -n kogito2
----

. Deploy the application:
+
----
$ oc process -f openshift/kafka-consumer-native.yml | oc create -f - -n kogito2
----

=== Test the application

. Create a travel booking in the Kogito Travel Agency application using the application UI or the Swagger UI. +
As an example, use the following payload:
+
----
{
"traveller" : {
"firstName" : "John",
"lastName" : "Doe",
"email" : "john.doe@example.com",
"nationality" : "Polish",
"address" : {
"street" : "Main Street",
"city" : "London",
"zipCode" : "12345",
"country" : "UK"
}
},
"trip" : {
"city" : "New York",
"country" : "US",
"begin" : "2019-12-10T00:00:00.000+02:00",
"end" : "2019-12-31T00:00:00.000+02:00"
}
}
----
+
According to the rules defined in both applications, a visa application is required for this trip, and the visa application cannot be processed automatically.

. Verify using the Kogito Travel Agency UI that a travel booking has been created.
+
image:images/travel-agency-ui.png[]
. Complete the Visa application task. Fill in a bogus passport number, and a duration of 30 (days) and submit the application.
. Verify in the Visa application that a Visa application has been created which requires manual approval:
+
image::images/visa-approval-ui.png[]

. Check the logs of the Kafka Consumer app. Note that several events have been sent by the Kogito runtimes to the `kogito-processinstances-events` Kafka topic. The events contain information about the process instance, the nodes triggered and the state of the process variables:
+
----
2019-08-27 01:20:25,541 INFO  [com.red.bti.MessageSource] (vert.x-eventloop-thread-0) Consumed message from topic 'kogito-processinstances-events', partition '5'
2019-08-27 01:20:25,541 INFO  [com.red.bti.MessageSource] (vert.x-eventloop-thread-0)     Message key: null
2019-08-27 01:20:25,541 INFO  [com.red.bti.MessageSource] (vert.x-eventloop-thread-0)     Message value: {"data":{"id":"f10fca96-9a9a-412f-83aa-cecfc14819f8","nodeInstances":[{"id":"82258d5b-5da4-4414-804a-20889ba8af94","nodeDefinitionId":"UserTask_1","nodeId":"4","nodeName":"Apply for visa","nodeType":"HumanTaskNode","triggerTime":"2019-08-26T23:20:25.136Z[UTC]"},{"id":"2c1dc57d-199f-42e4-b241-138a9daa2ea3","leaveTime":"2019-08-26T23:20:25.136Z[UTC]","nodeDefinitionId":"ExclusiveGateway_1","nodeId":"3","nodeName":"is visa required","nodeType":"Split","triggerTime":"2019-08-26T23:20:25.134Z[UTC]"},{"id":"ae977877-c86d-4e69-adea-fc7e599c93a6","leaveTime":"2019-08-26T23:20:25.134Z[UTC]","nodeDefinitionId":"BusinessRuleTask_1","nodeId":"2","nodeName":"Visa check","nodeType":"RuleSetNode","triggerTime":"2019-08-26T23:20:24.843Z[UTC]"},{"id":"6ef2664c-8b27-47b5-8e4f-84082622603b","leaveTime":"2019-08-26T23:20:24.843Z[UTC]","nodeDefinitionId":"StartEvent_1","nodeId":"1","nodeName":"StartProcess","nodeType":"StartNode","triggerTime":"2019-08-26T23:20:24.842Z[UTC]"}],"processId":"travels","processName":"travels","startDate":"2019-08-26T23:20:24.839Z[UTC]","state":1,"variables":{"traveller":{"address":{"city":"London","country":"UK","street":"Main Street","zipCode":"12345"},"email":"john.doe@example.com","firstName":"John","lastName":"Doe","nationality":"Polish"},"trip":{"begin":"2019-12-09T22:00:00Z[UTC]","city":"New York","country":"US","end":"2019-12-30T22:00:00Z[UTC]","visaRequired":true}}},"id":"81a6bed4-afd7-4e99-9fcd-87801f7756ab","kogitoProcessId":"travels","kogitoProcessinstanceId":"f10fca96-9a9a-412f-83aa-cecfc14819f8","kogitoProcessinstanceState":"1","specversion":"0.3","time":"2019-08-26T23:20:25.331Z[UTC]","type":"ProcessInstanceEvent"}
2019-08-27 01:27:54,736 INFO  [com.red.bti.MessageSource] (vert.x-eventloop-thread-0) Consumed message from topic 'kogito-processinstances-events', partition '6'
2019-08-27 01:27:54,736 INFO  [com.red.bti.MessageSource] (vert.x-eventloop-thread-0)     Message key: null
2019-08-27 01:27:54,736 INFO  [com.red.bti.MessageSource] (vert.x-eventloop-thread-0)     Message value: {"data":{"endDate":"2019-08-26T23:27:54.656Z[UTC]","id":"7cec4f77-2441-471c-bd20-17180b88e53d","nodeInstances":[{"id":"ee146869-ea3e-4bb2-ae2d-9d47ef98f6ea","leaveTime":"2019-08-26T23:27:54.656Z[UTC]","nodeDefinitionId":"EndEvent_1","nodeId":"3","nodeName":"End Event 1","nodeType":"EndNode","triggerTime":"2019-08-26T23:27:54.656Z[UTC]"},{"id":"6c9d8327-a3f3-4138-806a-fd0bb2f9e35e","leaveTime":"2019-08-26T23:27:54.656Z[UTC]","nodeDefinitionId":"ServiceTask_1","nodeId":"2","nodeName":"Book hotel","nodeType":"WorkItemNode","triggerTime":"2019-08-26T23:27:54.655Z[UTC]"},{"id":"ad4f2763-ac5c-48ec-8fe8-bb3c2263d379","leaveTime":"2019-08-26T23:27:54.655Z[UTC]","nodeDefinitionId":"StartEvent_1","nodeId":"1","nodeName":"StartProcess","nodeType":"StartNode","triggerTime":"2019-08-26T23:27:54.655Z[UTC]"}],"parentInstanceId":"f10fca96-9a9a-412f-83aa-cecfc14819f8","processId":"hotelBooking","processName":"HotelBooking","rootInstanceId":"f10fca96-9a9a-412f-83aa-cecfc14819f8","rootProcessId":"travels","startDate":"2019-08-26T23:27:54.655Z[UTC]","state":2,"variables":{"trip":{"begin":"2019-12-09T22:00:00Z[UTC]","city":"New York","country":"US","end":"2019-12-30T22:00:00Z[UTC]","visaRequired":true},"hotel":{"address":{"city":"New York","country":"US","street":"street","zipCode":"12345"},"bookingNumber":"XX-012345","name":"Perfect hotel","phone":"09876543"},"traveller":{"address":{"city":"London","country":"UK","street":"Main Street","zipCode":"12345"},"email":"john.doe@example.com","firstName":"John","lastName":"Doe","nationality":"Polish"}}},"id":"a9708b97-65ea-4161-a7f8-98077ba2cc30","kogitoParentProcessinstanceId":"f10fca96-9a9a-412f-83aa-cecfc14819f8","kogitoProcessId":"hotelBooking","kogitoProcessinstanceId":"7cec4f77-2441-471c-bd20-17180b88e53d","kogitoProcessinstanceState":"2","kogitoRootProcessId":"travels","kogitoRootProcessinstanceId":"f10fca96-9a9a-412f-83aa-cecfc14819f8","specversion":"0.3","time":"2019-08-26T23:27:54.725Z[UTC]","type":"ProcessInstanceEvent"}
2019-08-27 01:27:54,766 INFO  [com.red.bti.MessageSource] (vert.x-eventloop-thread-0) Consumed message from topic 'kogito-processinstances-events', partition '3'
2019-08-27 01:27:54,766 INFO  [com.red.bti.MessageSource] (vert.x-eventloop-thread-0)     Message key: null
2019-08-27 01:27:54,766 INFO  [com.red.bti.MessageSource] (vert.x-eventloop-thread-0)     Message value: {"data":{"id":"f10fca96-9a9a-412f-83aa-cecfc14819f8","nodeInstances":[{"id":"53a18bcd-70a6-4de4-bbe1-0e5582efdf53","leaveTime":"2019-08-26T23:27:54.651Z[UTC]","nodeDefinitionId":"EndEvent_2","nodeId":"13","nodeName":"Send visa application","nodeType":"EndNode","triggerTime":"2019-08-26T23:27:54.65Z[UTC]"},{"id":"477039e9-1453-4aba-a977-fafcc340ebd2","leaveTime":"2019-08-26T23:27:54.66Z[UTC]","nodeDefinitionId":"CallActivity_1","nodeId":"7","nodeName":"Book Hotel","nodeType":"SubProcessNode","triggerTime":"2019-08-26T23:27:54.652Z[UTC]"},{"id":"634107c9-9ed9-4b85-8687-6faa03497abf","nodeDefinitionId":"UserTask_2","nodeId":"10","nodeName":"Confirm travel","nodeType":"HumanTaskNode","triggerTime":"2019-08-26T23:27:54.721Z[UTC]"},{"id":"9b97b569-35cc-4f2a-9b49-1fb04a9fd9df","leaveTime":"2019-08-26T23:27:54.721Z[UTC]","nodeDefinitionId":"ParallelGateway_2","nodeId":"9","nodeName":"Join","nodeType":"Join","triggerTime":"2019-08-26T23:27:54.721Z[UTC]"},{"id":"9aea64f9-d112-4b36-9841-87402948a947","leaveTime":"2019-08-26T23:27:54.721Z[UTC]","nodeDefinitionId":"CallActivity_2","nodeId":"8","nodeName":"Book Flight","nodeType":"SubProcessNode","triggerTime":"2019-08-26T23:27:54.66Z[UTC]"},{"id":"325e767f-642c-4d34-bb0f-c16d0e74ef61","leaveTime":"2019-08-26T23:27:54.66Z[UTC]","nodeDefinitionId":"ParallelGateway_1","nodeId":"6","nodeName":"Book","nodeType":"Split","triggerTime":"2019-08-26T23:27:54.652Z[UTC]"},{"id":"8bb175ea-6ce4-42e1-acc7-0c995f49b1b8","leaveTime":"2019-08-26T23:27:54.652Z[UTC]","nodeDefinitionId":"ExclusiveGateway_2","nodeId":"5","nodeName":"Join","nodeType":"Join","triggerTime":"2019-08-26T23:27:54.652Z[UTC]"},{"id":"2b1d0914-1017-44ee-9ec8-e6c9f6ad3768","leaveTime":"2019-08-26T23:27:54.652Z[UTC]","nodeDefinitionId":"ParallelGateway_3","nodeId":"12","nodeName":"Apply for visa and continue","nodeType":"Split","triggerTime":"2019-08-26T23:27:54.649Z[UTC]"},{"id":"82258d5b-5da4-4414-804a-20889ba8af94","leaveTime":"2019-08-26T23:27:54.649Z[UTC]","nodeDefinitionId":"UserTask_1","nodeId":"4","nodeName":"Apply for visa","nodeType":"HumanTaskNode","triggerTime":"2019-08-26T23:20:25.136Z[UTC]"}],"parentInstanceId":"","processId":"travels","processName":"travels","rootInstanceId":"","rootProcessId":"","startDate":"2019-08-26T23:20:24.839Z[UTC]","state":1,"variables":{"flight":{"arrival":"2019-12-30T22:00:00Z[UTC]","departure":"2019-12-09T22:00:00Z[UTC]","flightNumber":"MX555"},"hotel":{"address":{"city":"New York","country":"US","street":"street","zipCode":"12345"},"bookingNumber":"XX-012345","name":"Perfect hotel","phone":"09876543"},"trip":{"begin":"2019-12-09T22:00:00Z[UTC]","city":"New York","country":"US","end":"2019-12-30T22:00:00Z[UTC]","visaRequired":true},"visaApplication":{"city":"New York","country":"US","duration":30,"firstName":"John","lastName":"Doe","nationality":"Polish","passportNumber":"AB12345"},"traveller":{"address":{"city":"London","country":"UK","street":"Main Street","zipCode":"12345"},"email":"john.doe@example.com","firstName":"John","lastName":"Doe","nationality":"Polish"}}},"id":"03f53c42-82af-40b3-9fe2-411a696f13ac","kogitoParentProcessinstanceId":"","kogitoProcessId":"travels","kogitoProcessinstanceId":"f10fca96-9a9a-412f-83aa-cecfc14819f8","kogitoProcessinstanceState":"1","kogitoRootProcessId":"","kogitoRootProcessinstanceId":"","specversion":"0.3","time":"2019-08-26T23:27:54.725Z[UTC]","type":"ProcessInstanceEvent"}
2019-08-27 01:27:54,779 INFO  [com.red.bti.MessageSource] (vert.x-eventloop-thread-0) Consumed message from topic 'kogito-processinstances-events', partition '4'
2019-08-27 01:27:54,779 INFO  [com.red.bti.MessageSource] (vert.x-eventloop-thread-0)     Message key: null
2019-08-27 01:27:54,779 INFO  [com.red.bti.MessageSource] (vert.x-eventloop-thread-0)     Message value: {"data":{"endDate":"2019-08-26T23:27:54.661Z[UTC]","id":"0e0a619d-cfbe-458f-9857-b69cab05ef2c","nodeInstances":[{"id":"4c466f40-e9e3-4d3c-b410-ddf8827d564b","leaveTime":"2019-08-26T23:27:54.661Z[UTC]","nodeDefinitionId":"EndEvent_1","nodeId":"3","nodeName":"End Event 1","nodeType":"EndNode","triggerTime":"2019-08-26T23:27:54.661Z[UTC]"},{"id":"b21ba801-a9f6-4437-a0f0-d2c2d11dab08","leaveTime":"2019-08-26T23:27:54.661Z[UTC]","nodeDefinitionId":"ServiceTask_1","nodeId":"2","nodeName":"Book flight","nodeType":"WorkItemNode","triggerTime":"2019-08-26T23:27:54.661Z[UTC]"},{"id":"03607383-54de-4d24-9c6f-105a7f0c9fe6","leaveTime":"2019-08-26T23:27:54.661Z[UTC]","nodeDefinitionId":"StartEvent_1","nodeId":"1","nodeName":"StartProcess","nodeType":"StartNode","triggerTime":"2019-08-26T23:27:54.661Z[UTC]"}],"parentInstanceId":"f10fca96-9a9a-412f-83aa-cecfc14819f8","processId":"flightBooking","processName":"FlightBooking","rootInstanceId":"f10fca96-9a9a-412f-83aa-cecfc14819f8","rootProcessId":"travels","startDate":"2019-08-26T23:27:54.661Z[UTC]","state":2,"variables":{"flight":{"arrival":"2019-12-30T22:00:00Z[UTC]","departure":"2019-12-09T22:00:00Z[UTC]","flightNumber":"MX555"},"trip":{"begin":"2019-12-09T22:00:00Z[UTC]","city":"New York","country":"US","end":"2019-12-30T22:00:00Z[UTC]","visaRequired":true},"traveller":{"address":{"city":"London","country":"UK","street":"Main Street","zipCode":"12345"},"email":"john.doe@example.com","firstName":"John","lastName":"Doe","nationality":"Polish"}}},"id":"bf6663b8-b5d8-4cc9-adb7-1ef406f1403b","kogitoParentProcessinstanceId":"f10fca96-9a9a-412f-83aa-cecfc14819f8","kogitoProcessId":"flightBooking","kogitoProcessinstanceId":"0e0a619d-cfbe-458f-9857-b69cab05ef2c","kogitoProcessinstanceState":"2","kogitoRootProcessId":"travels","kogitoRootProcessinstanceId":"f10fca96-9a9a-412f-83aa-cecfc14819f8","specversion":"0.3","time":"2019-08-26T23:27:54.725Z[UTC]","type":"ProcessInstanceEvent"}
2019-08-27 01:27:55,341 INFO  [com.red.bti.MessageSource] (vert.x-eventloop-thread-0) Consumed message from topic 'kogito-processinstances-events', partition '4'
2019-08-27 01:27:55,341 INFO  [com.red.bti.MessageSource] (vert.x-eventloop-thread-0)     Message key: null
2019-08-27 01:27:55,341 INFO  [com.red.bti.MessageSource] (vert.x-eventloop-thread-0)     Message value: {"data":{"id":"792592a6-5e48-450d-aa79-bd9eff2e4585","nodeInstances":[{"id":"b51a996c-eae1-4e38-ac71-ad0777731656","nodeDefinitionId":"UserTask_1","nodeId":"5","nodeName":"Manual visa approval","nodeType":"HumanTaskNode","triggerTime":"2019-08-26T23:27:54.946Z[UTC]"},{"id":"4cb6b4b4-7fc0-45da-8a01-61b6ff9336ea","leaveTime":"2019-08-26T23:27:54.946Z[UTC]","nodeDefinitionId":"ExclusiveGateway_1","nodeId":"3","nodeName":"Visa approved?","nodeType":"Split","triggerTime":"2019-08-26T23:27:54.944Z[UTC]"},{"id":"d911af00-7bd7-483e-8f8d-6d3dbc2e089d","leaveTime":"2019-08-26T23:27:54.944Z[UTC]","nodeDefinitionId":"BusinessRuleTask_1","nodeId":"2","nodeName":"Automatic visa approvals","nodeType":"RuleSetNode","triggerTime":"2019-08-26T23:27:54.836Z[UTC]"},{"id":"77f39a1d-c63b-4339-982e-d433cb9658f4","leaveTime":"2019-08-26T23:27:54.836Z[UTC]","nodeDefinitionId":"StartEvent_1","nodeId":"1","nodeName":"StartProcess","nodeType":"StartNode","triggerTime":"2019-08-26T23:27:54.835Z[UTC]"}],"processId":"visaApplications","processName":"ProcessVisaApplications","startDate":"2019-08-26T23:27:54.832Z[UTC]","state":1,"variables":{"visaApplication":{"approved":false,"city":"New York","country":"US","duration":30,"firstName":"John","lastName":"Doe","nationality":"Polish","passportNumber":"AB12345"}}},"id":"ca960b51-57a4-4583-a244-221e11e9f761","kogitoProcessId":"visaApplications","kogitoProcessinstanceId":"792592a6-5e48-450d-aa79-bd9eff2e4585","kogitoProcessinstanceState":"1","specversion":"0.3","time":"2019-08-26T23:27:55.249Z[UTC]","type":"ProcessInstanceEvent"}
----


== Lab 5: Kogito Data Index Service

The _Kogito Data Index Service_ is a Quarkus based application that aims to capture and index data produced by one more Kogito runtime services. It consumes the events emitted by the Kogito runtime event publisher and stores and indexes them in an Infinispan cluster.

image::images/data-index-architecture.jpg[]

The Data Index Service is not intended to be used as permanent storage or audit log information. The focus is to make business domain data easily accessible for processes that are currently in progress.

In its current version, it uses Kakfa messaging to consume _CloudEvents_ based messages from Kogito runtimes, process and index the information for later consumption via GraphQL queries.

The Data Index Service is capable of indexing custom process models, if it has access to the Protobuf definition files of the model.

The Data Index Service is bundled with the _GraphiQL_ (https://github.com/graphql/graphiql) UI, which allows exploring and querying the available data model. Alternatively, it is also possible to use a GraphQL client API to communicate with the exposed GraphQL endpoint.

In this lab we will deploy the Data Index Service to OpenShift, and explore its indexing and querying functionalities.

. From the `/home/lab-user/kogito-travel-agency-tutorial` folder, navigate to the `data-index-service` folder.
+
----
$ cd data-index-service
----

. Create a ConfigMap for the Data Index Service to set the location of the Infinispan server and the Kafka broker.
.. On the lab workstation, create a file `/tmp/application.properties`. Delete the existing file from the previous lab.
+
----
$ rm /tmp/application.properties
$ touch /tmp/application.properties
----
+
Using `vim`, add the following content to the file:
+
----
quarkus.vertx-http.port=8080

quarkus.infinispan-client.server-list=infinispan-server.kogito2.svc:11222

mp.messaging.incoming.kogito-processinstances-events.bootstrap.servers=kafka-cluster-kafka-bootstrap.kafka-cluster.svc:9092
mp.messaging.incoming.kogito-processinstances-events.group.id=data-index-service
mp.messaging.incoming.kogito-processinstances-events.auto.offset.reset=earliest

kogito.cache.domain.template=default
kogito.protobuf.folder=/deployments/proto
----
+
* `kogito.cache.domain.template` is the Infinispan cache template used by the Data Index Service. This tempate must exist on the Infinispan server.
* `kogito.protobuf.folder` is the directory where the Data Index Service looks for Protobuf definition files for domain specific models.
+
.. Create a ConfigMap from the `application.properties` file:
+
----
$ oc create configmap data-index-service --from-file=/tmp/application.properties -n kogito2
----

. Create a ConfigMap for the Protobuf files for the Data Index Service.
.. The Protobuf definition files for the domain models for the Kogito Travel Agency and Visas applications are generated when the project is build. They are stored in the `target/classes/persistence` directory of the project.
+
----
$ ls ../03-kogito-travel-agency/target/classes/persistence
----
+
.Output
----
kogito-application.proto  travels.proto
----

.. Create a ConfigMap from the Protobuf files:
+
----
$ oc create configmap data-index-service-proto --from-file=../03-kogito-travel-agency/target/classes/persistence/travels.proto --from-file=../03-kogito-visas/target/classes/persistence/visaApplications.proto -n kogito2
----

. Deploy the Data Index Service on OpenShift. We use a pre-built image of the application.
+
----
$ oc process -f openshift/data-index-service.yml | oc create -f - -n kogito2
----
+
.Output
----
service/data-index-service created
route.route.openshift.io/data-index-service created
deployment.apps/data-index-service created
----

. Create a number of travel applications and visa applications using the Kogito Travel Agency and Kogito Visas UI (or the Swagger UI)

. In a browser window, navigate to the URL of the Data Index Service.
+
image::images/data-index-service-ui.png[]

. In the left pane of the UI, create a GraphQL query. Notice the autocomplete features of the UI. For example, to query for all the process instances in the Kogito runtimes:
+
----
{
  ProcessInstances {
    id
    processId
    state
    variables
  }
}
----
+
image::images/data-index-service-ui-query.png[]

. It is possible to filter on fields. For example, to query for active process instances of processId `travels`:
+
----
{
  ProcessInstances(filter: {state: ACTIVE, limit: 10, processId: "travels"}) {
    id
    processId
    state
    variables
  }
}
----

. The Data Index Service knows about the domain specific models used in the Kogito runtimes, so you can create queries using these models:
+
----
{
  Travels {
    traveller {
      firstName
      lastName
      nationality
    }
  }
}
----
+
image::images/data-index-service-ui-query-2.png[]
+
----
{
  VisaApplications {
    visaApplication {
      firstName
      lastName
      duration
      country
    }
  }
}
----
+
image::images/data-index-service-ui-query-3.png[]


=== Monitoring

Kogito comes with built-in functionality to expose metrics about process and rules execution in Prometheus format. To enable this functionality, a dependency to the `org.kie.kogito:monitoring-prometheus-addon` library must be added to the project, and the Kogito Prometheus event listeners must be registered with the engine. Prometheus metrics are exposed on the `/metrics` path.

Both the Kogito Travel Agency as the Kogito Visa applications have been configured to emit Prometheus metrics.

In this lab, we will set up the pre-installed monitoring stack on the OpenShift cluster to capture the Kogito runtime metrics and deploy a Grafana dashboard to display the metrics.

The monitoring stack on the OpenShift cluster is installed in the `monitoring` namespace. It consists of Prometheus and Grafana. The stack is managed by a set of operators, and its state defined with Kubernetes Custom Resources. It is the same stack as used in the Integreatly project.

. From the `/home/lab-user/kogito-travel-agency-tutorial` folder, navigate to the `monitoring` folder.
+
----
$ cd monitoring
----
. Using `oc`, login into the cluster as user `admin` - deploying the monitoring CR's require cluster admin rights on this cluster:
+
----
$ oc login -u admin https://master00.example.com
----
. Label the `kogito2` namespace with a label `monitoring key` and value `kogito`:
+
----
$ oc label namespace kogito2 monitoring-key=kogito
----
* This registers the namespace as being watched by the monitoring operators.
. Label the Kogito application services:
+
----
$ oc label service kogito-visas monitoring=prometheus -n kogito2
$ oc label service kogito-travel-agency monitoring=prometheus -n kogito2
----
. Create a ServiceMonitor Custom Resource for the labeled services. The CR will be picked up by the Prometheus operator, and corresponding Prometheus scraping targets will be created.
+
----
$ oc create -f openshift/service-monitor.yml -n kogito2
----
+
.Output
----
servicemonitor.monitoring.coreos.com/kogito-monitor-services created
----
. Verify that the Prometheus scraping targets have been created and are active.
.. Open a browser window, and navigate to the Prometheus landing page on your cluster - https://prometheus-route-monitoring.apps-$GUID.generic.opentlc.com. Create a security exception.
+
image::images/prometheus-landing-page.png[]
.. In the Prometheus UI, navigate to `Status -> Targets`. Expect to see two targets (one for each Kogito runtime), with status `UP`:
+
image::images/prometheus-targets.png[]
.. Navigate back to the landing page and click on the `insert metric at cursor` drop-down to see a list of available metrics:
+
image::images/prometheus-metrics.png[]
* Note that the list mightnot show metric types for which data has not been generated yet.
. Deploy a dashboard to Grafana. The `openshift/kogitotravel-grafana-dashboard.yml` contains a pre-built GrafanaDashboard CR which displays the metrics gathered by Prometheus.
+
----
$ oc create -f openshift/kogitotravel-grafana-dashboard.yml -n kogito2
----
+
.Output
----
grafanadashboard.integreatly.org/kogito-dashboard created
----

. In a browser window, navigate to the Grafan landing page - https://grafana-route-monitoring.apps-$GUID.generic.opentlc.com. Click on the `Home` dropdown and select the `KogitoTravel dashboard`:
+
image::images/grafana-home-page.png[]
+
image::images/grafana-kogitotravel-dashboard.png[]

. Create some travel bookings and visa applications to generate data for the dashboard.

. The Grafana dashboard is read-only for anonymous users. If you want to edit the dashboard, proceed as follows:
.. Edit the `grafana-config` ConfigMap in the `monitoring` namespace. Set `disable_login_form` to false in the `auth` section:
+
----
[auth]
# Set to true to disable (hide) the login form, useful if you use OAuth, defaults to false.
disable_login_form = false
----
.. Scale the Grafana deployment down and up again to force the creation of a new pod with the modified configmap mounted.
.. In a browser window, navigate to the Grafana landing page, click on the `sign-in` button on the lower left, and log in with the admin username and password as specified in the `grafana-config` ConfigMap.
.. Now you can edit and adjust the dashboard to your liking:
+
image::images/grafana-kogitotravel-dashboard-edit.png[]


Congratulations! You've reached the end of this lab.
